name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true

env:
  NATS_VERSION: "2.10.24"
  GH_ORG: joyautomation

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Download pre-built binaries from each module's latest GitHub release
  # Each module repo runs its own compile workflow on tag push
  # ═══════════════════════════════════════════════════════════════════════════
  download-modules:
    strategy:
      matrix:
        module:
          - { repo: tentacle-graphql,    name: tentacle-graphql,    platforms: "linux-amd64 linux-arm64 darwin-arm64 windows-amd64" }
          - { repo: tentacle-web,        name: tentacle-web,        platforms: "linux-amd64 linux-arm64 darwin-arm64 windows-amd64" }
          - { repo: tentacle-ethernetip, name: tentacle-ethernetip, platforms: "linux-amd64 linux-arm64 darwin-arm64 windows-amd64" }
          - { repo: tentacle-mqtt,       name: tentacle-mqtt,       platforms: "linux-amd64 linux-arm64 darwin-arm64 windows-amd64" }
          - { repo: tentacle-opcua-go,   name: tentacle-opcua,      platforms: "linux-amd64 linux-arm64 darwin-arm64 windows-amd64" }
          - { repo: tentacle-network,    name: tentacle-network,    platforms: "linux-amd64 linux-arm64" }
          - { repo: tentacle-nftables,   name: tentacle-nftables,   platforms: "linux-amd64 linux-arm64" }
    runs-on: ubuntu-latest
    steps:
      - name: Download ${{ matrix.module.name }} binaries
        run: |
          mkdir -p artifacts
          for PLATFORM in ${{ matrix.module.platforms }}; do
            EXT=""
            if [[ "$PLATFORM" == windows-* ]]; then EXT=".exe"; fi
            FILENAME="${{ matrix.module.name }}-${PLATFORM}${EXT}"
            echo "Downloading ${FILENAME}..."
            curl -fSL \
              "https://github.com/${{ env.GH_ORG }}/${{ matrix.module.repo }}/releases/latest/download/${FILENAME}" \
              -o "artifacts/${FILENAME}" || echo "WARNING: ${FILENAME} not found in latest release"
          done

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.module.name }}
          path: artifacts/*

  # ═══════════════════════════════════════════════════════════════════════════
  # Download NATS server binaries
  # ═══════════════════════════════════════════════════════════════════════════
  download-nats:
    strategy:
      matrix:
        target:
          - { suffix: linux-amd64.tar.gz,  os: linux,   arch: amd64, bin: nats-server }
          - { suffix: linux-arm64.tar.gz,  os: linux,   arch: arm64, bin: nats-server }
          - { suffix: darwin-arm64.tar.gz, os: darwin,  arch: arm64, bin: nats-server }
          - { suffix: windows-amd64.zip,   os: windows, arch: amd64, bin: nats-server.exe }
    runs-on: ubuntu-latest
    steps:
      - name: Download NATS server v${{ env.NATS_VERSION }}
        run: |
          mkdir -p dist
          URL="https://github.com/nats-io/nats-server/releases/download/v${NATS_VERSION}/nats-server-v${NATS_VERSION}-${{ matrix.target.suffix }}"
          curl -fSL "$URL" -o /tmp/nats-server-archive

          if [[ "${{ matrix.target.suffix }}" == *.zip ]]; then
            unzip -j /tmp/nats-server-archive "*/${{ matrix.target.bin }}" -d dist/
          else
            tar xzf /tmp/nats-server-archive --strip-components=1 -C dist/ \
              "nats-server-v${NATS_VERSION}-${{ matrix.target.os }}-${{ matrix.target.arch }}/${{ matrix.target.bin }}"
          fi

          EXT=$([ "${{ matrix.target.os }}" = "windows" ] && echo ".exe" || echo "")
          mv dist/${{ matrix.target.bin }} dist/nats-server-${{ matrix.target.os }}-${{ matrix.target.arch }}${EXT}

      - uses: actions/upload-artifact@v4
        with:
          name: nats-server-${{ matrix.target.os }}-${{ matrix.target.arch }}
          path: dist/nats-server-*

  # ═══════════════════════════════════════════════════════════════════════════
  # Package platform archives + Makeself .run
  # Deploy scripts come from this repo (joyautomation/tentacle)
  # ═══════════════════════════════════════════════════════════════════════════
  package:
    needs: [download-modules, download-nats]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
          fi

      - name: Package platform archives
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CROSS_MODULES="tentacle-graphql tentacle-web tentacle-ethernetip tentacle-opcua tentacle-mqtt"
          LINUX_MODULES="tentacle-network tentacle-nftables"

          mkdir -p dist

          for PLATFORM in linux-amd64 linux-arm64 darwin-arm64 windows-amd64; do
            OS="${PLATFORM%-*}"
            ARCH="${PLATFORM#*-}"
            EXT=""
            if [ "$OS" = "windows" ]; then EXT=".exe"; fi

            DIR="tentacle-v${VERSION}-${PLATFORM}"
            mkdir -p "${DIR}/bin" "${DIR}/deploy/systemd" "${DIR}/config"

            # Copy cross-platform module binaries
            for MOD in $CROSS_MODULES; do
              SRC="artifacts/${MOD}/${MOD}-${PLATFORM}${EXT}"
              if [ -f "$SRC" ]; then
                cp "$SRC" "${DIR}/bin/${MOD}${EXT}"
                chmod +x "${DIR}/bin/${MOD}${EXT}" 2>/dev/null || true
              fi
            done

            # Copy NATS server
            NATS_SRC="artifacts/nats-server-${PLATFORM}/nats-server-${PLATFORM}${EXT}"
            if [ -f "$NATS_SRC" ]; then
              cp "$NATS_SRC" "${DIR}/bin/nats-server${EXT}"
              chmod +x "${DIR}/bin/nats-server${EXT}" 2>/dev/null || true
            fi

            # Copy Linux-only modules
            if [ "$OS" = "linux" ]; then
              for MOD in $LINUX_MODULES; do
                SRC="artifacts/${MOD}/${MOD}-${PLATFORM}"
                if [ -f "$SRC" ]; then
                  cp "$SRC" "${DIR}/bin/${MOD}"
                  chmod +x "${DIR}/bin/${MOD}"
                fi
              done
            fi

            # Copy deploy files from this repo
            cp deploy/install.sh "${DIR}/deploy/"
            chmod +x "${DIR}/deploy/install.sh"
            sed -i "s/{{VERSION}}/${VERSION}/g" "${DIR}/deploy/install.sh"
            cp deploy/docker-compose.yml "${DIR}/deploy/" 2>/dev/null || true
            cp deploy/Dockerfile.* "${DIR}/deploy/" 2>/dev/null || true
            cp config/tentacle.env.example "${DIR}/config/"

            if [ "$OS" = "linux" ]; then
              cp deploy/systemd/*.service "${DIR}/deploy/systemd/"
            fi

            if [ "$OS" = "windows" ] || [ "$OS" = "darwin" ]; then
              cp deploy/install.ps1 "${DIR}/deploy/"
              sed -i "s/{{VERSION}}/${VERSION}/g" "${DIR}/deploy/install.ps1"
            fi

            # Create archive
            if [ "$OS" = "windows" ]; then
              zip -r "dist/tentacle-v${VERSION}-${PLATFORM}.zip" "${DIR}"
            else
              tar czf "dist/tentacle-v${VERSION}-${PLATFORM}.tar.gz" "${DIR}"
            fi
          done

      - name: Build Makeself .run archives
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sudo apt-get install -y -qq makeself

          for ARCH in amd64 arm64; do
            PLATFORM="linux-${ARCH}"
            SRC_DIR="tentacle-v${VERSION}-${PLATFORM}"
            if [ -d "$SRC_DIR" ]; then
              makeself --gzip --sha256 \
                "$SRC_DIR" \
                "dist/tentacle-v${VERSION}-${PLATFORM}.run" \
                "Tentacle v${VERSION} Installer (Linux ${ARCH})" \
                ./deploy/install.sh --bundled
            fi
          done

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > SHA256SUMS

      - uses: actions/upload-artifact@v4
        with:
          name: release-archives
          path: dist/

  # ═══════════════════════════════════════════════════════════════════════════
  # Create GitHub Release
  # ═══════════════════════════════════════════════════════════════════════════
  release:
    needs: [package]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download release archives
        uses: actions/download-artifact@v4
        with:
          name: release-archives
          path: dist/

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Tentacle v${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            dist/tentacle-v*.tar.gz
            dist/tentacle-v*.zip
            dist/tentacle-v*.run
            dist/SHA256SUMS
