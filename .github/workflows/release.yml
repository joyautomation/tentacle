name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true

env:
  NATS_VERSION: "2.10.24"
  DENO_VERSION: "2.3.3"
  GH_ORG: joyautomation

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Download Deno runtime binaries (one per platform, shared by all services)
  # ═══════════════════════════════════════════════════════════════════════════
  download-deno:
    strategy:
      matrix:
        target:
          - { deno_target: x86_64-unknown-linux-gnu,  platform: linux-amd64,   ext: "" }
          - { deno_target: aarch64-unknown-linux-gnu, platform: linux-arm64,   ext: "" }
          - { deno_target: aarch64-apple-darwin,      platform: darwin-arm64,  ext: "" }
          - { deno_target: x86_64-pc-windows-msvc,    platform: windows-amd64, ext: ".exe" }
    runs-on: ubuntu-latest
    steps:
      - name: Download Deno v${{ env.DENO_VERSION }} for ${{ matrix.target.platform }}
        run: |
          mkdir -p dist
          curl -fSL \
            "https://dl.deno.land/release/v${DENO_VERSION}/deno-${{ matrix.target.deno_target }}.zip" \
            -o /tmp/deno.zip
          unzip -j /tmp/deno.zip "deno${{ matrix.target.ext }}" -d /tmp/
          mv "/tmp/deno${{ matrix.target.ext }}" "dist/deno-${{ matrix.target.platform }}${{ matrix.target.ext }}"

      - uses: actions/upload-artifact@v4
        with:
          name: deno-${{ matrix.target.platform }}
          path: dist/deno-*

  # ═══════════════════════════════════════════════════════════════════════════
  # Download NATS server binaries
  # ═══════════════════════════════════════════════════════════════════════════
  download-nats:
    strategy:
      matrix:
        target:
          - { suffix: linux-amd64.tar.gz,  os: linux,   arch: amd64, bin: nats-server }
          - { suffix: linux-arm64.tar.gz,  os: linux,   arch: arm64, bin: nats-server }
          - { suffix: darwin-arm64.tar.gz, os: darwin,  arch: arm64, bin: nats-server }
          - { suffix: windows-amd64.zip,   os: windows, arch: amd64, bin: nats-server.exe }
    runs-on: ubuntu-latest
    steps:
      - name: Download NATS server v${{ env.NATS_VERSION }}
        run: |
          mkdir -p dist
          URL="https://github.com/nats-io/nats-server/releases/download/v${NATS_VERSION}/nats-server-v${NATS_VERSION}-${{ matrix.target.suffix }}"
          curl -fSL "$URL" -o /tmp/nats-server-archive

          if [[ "${{ matrix.target.suffix }}" == *.zip ]]; then
            unzip -j /tmp/nats-server-archive "*/${{ matrix.target.bin }}" -d dist/
          else
            tar xzf /tmp/nats-server-archive --strip-components=1 -C dist/ \
              "nats-server-v${NATS_VERSION}-${{ matrix.target.os }}-${{ matrix.target.arch }}/${{ matrix.target.bin }}"
          fi

          EXT=$([ "${{ matrix.target.os }}" = "windows" ] && echo ".exe" || echo "")
          mv dist/${{ matrix.target.bin }} dist/nats-server-${{ matrix.target.os }}-${{ matrix.target.arch }}${EXT}

      - uses: actions/upload-artifact@v4
        with:
          name: nats-server-${{ matrix.target.os }}-${{ matrix.target.arch }}
          path: dist/nats-server-*

  # ═══════════════════════════════════════════════════════════════════════════
  # Download Deno service source/build tarballs from module releases
  # ═══════════════════════════════════════════════════════════════════════════
  download-deno-services:
    strategy:
      matrix:
        module:
          - { repo: tentacle-graphql,    artifact: tentacle-graphql-src.tar.gz }
          - { repo: tentacle-ethernetip, artifact: tentacle-ethernetip-src.tar.gz }
          - { repo: tentacle-mqtt,       artifact: tentacle-mqtt-src.tar.gz }
          - { repo: tentacle-network,    artifact: tentacle-network-src.tar.gz }
          - { repo: tentacle-nftables,   artifact: tentacle-nftables-src.tar.gz }
          - { repo: tentacle-modbus,     artifact: tentacle-modbus-src.tar.gz }
          - { repo: tentacle-web,        artifact: tentacle-web-build.tar.gz }
    runs-on: ubuntu-latest
    steps:
      - name: Download ${{ matrix.module.repo }}
        run: |
          mkdir -p artifacts
          curl -fSL \
            "https://github.com/${{ env.GH_ORG }}/${{ matrix.module.repo }}/releases/latest/download/${{ matrix.module.artifact }}" \
            -o "artifacts/${{ matrix.module.artifact }}"

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.module.repo }}-src
          path: artifacts/*

  # ═══════════════════════════════════════════════════════════════════════════
  # Download tentacle-opcua-go compiled binary (Go, no runtime overhead)
  # ═══════════════════════════════════════════════════════════════════════════
  download-opcua:
    strategy:
      matrix:
        target:
          - { platform: linux-amd64,   ext: "" }
          - { platform: linux-arm64,   ext: "" }
          - { platform: darwin-arm64,  ext: "" }
          - { platform: windows-amd64, ext: ".exe" }
    runs-on: ubuntu-latest
    steps:
      - name: Download tentacle-opcua for ${{ matrix.target.platform }}
        run: |
          mkdir -p artifacts
          FILENAME="tentacle-opcua-${{ matrix.target.platform }}${{ matrix.target.ext }}"
          curl -fSL \
            "https://github.com/${{ env.GH_ORG }}/tentacle-opcua-go/releases/latest/download/${FILENAME}" \
            -o "artifacts/${FILENAME}" || echo "WARNING: ${FILENAME} not found"

      - uses: actions/upload-artifact@v4
        with:
          name: tentacle-opcua-${{ matrix.target.platform }}
          path: artifacts/*

  # ═══════════════════════════════════════════════════════════════════════════
  # Package platform archives + Makeself .run
  # ═══════════════════════════════════════════════════════════════════════════
  package:
    needs: [download-deno, download-nats, download-deno-services, download-opcua]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Checkout tentacle-nats-schema
        uses: actions/checkout@v4
        with:
          repository: joyautomation/tentacle-nats-schema
          path: tentacle-nats-schema

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract service sources and pre-cache Deno dependencies
        run: |
          mkdir -p services

          # Extract Deno service source tarballs
          for svc in graphql ethernetip mqtt modbus network nftables; do
            TARBALL="artifacts/tentacle-${svc}-src/tentacle-${svc}-src.tar.gz"
            if [ -f "$TARBALL" ]; then
              tar xzf "$TARBALL" -C services/
              echo "Extracted tentacle-${svc}"
            fi
          done

          # Extract web build/ dir into services/tentacle-web/
          WEB_TARBALL="artifacts/tentacle-web-src/tentacle-web-build.tar.gz"
          if [ -f "$WEB_TARBALL" ]; then
            mkdir -p services/tentacle-web
            tar xzf "$WEB_TARBALL" -C services/tentacle-web/
            echo "Extracted tentacle-web"
          fi

          # Shared nats-schema
          cp -r tentacle-nats-schema services/tentacle-nats-schema
          rm -rf services/tentacle-nats-schema/.git

          # Pre-cache all Deno service dependencies for air-gapped installs.
          # The runner is linux-amd64; source files are platform-independent.
          # On other architectures, bytecode recompiles locally (no internet needed).
          export DENO_DIR="$(pwd)/deno-cache"
          mkdir -p "$DENO_DIR"
          for svc in graphql ethernetip mqtt modbus network nftables; do
            if [ -f "services/tentacle-${svc}/main.ts" ]; then
              echo "Caching deps for tentacle-${svc}..."
              (cd "services/tentacle-${svc}" && deno cache main.ts 2>&1) || \
                echo "WARNING: cache failed for tentacle-${svc}"
            fi
          done
          if [ -f "services/tentacle-web/build/index.js" ]; then
            echo "Caching deps for tentacle-web..."
            (cd services/tentacle-web && deno cache build/index.js 2>&1) || \
              echo "WARNING: cache failed for tentacle-web"
          fi

      - name: Package platform archives
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p dist

          for PLATFORM in linux-amd64 linux-arm64 darwin-arm64 windows-amd64; do
            OS="${PLATFORM%-*}"
            ARCH="${PLATFORM#*-}"
            EXT=""
            if [ "$OS" = "windows" ]; then EXT=".exe"; fi

            DIR="tentacle-v${VERSION}-${PLATFORM}"
            mkdir -p "${DIR}/bin" "${DIR}/services" "${DIR}/deploy/systemd" "${DIR}/config"

            # Deno runtime binary
            DENO_SRC="artifacts/deno-${PLATFORM}/deno-${PLATFORM}${EXT}"
            if [ -f "$DENO_SRC" ]; then
              cp "$DENO_SRC" "${DIR}/bin/deno${EXT}"
              chmod +x "${DIR}/bin/deno${EXT}" 2>/dev/null || true
            fi

            # NATS server
            NATS_SRC="artifacts/nats-server-${PLATFORM}/nats-server-${PLATFORM}${EXT}"
            if [ -f "$NATS_SRC" ]; then
              cp "$NATS_SRC" "${DIR}/bin/nats-server${EXT}"
              chmod +x "${DIR}/bin/nats-server${EXT}" 2>/dev/null || true
            fi

            # OPC UA Go binary
            OPCUA_SRC="artifacts/tentacle-opcua-${PLATFORM}/tentacle-opcua-${PLATFORM}${EXT}"
            if [ -f "$OPCUA_SRC" ]; then
              cp "$OPCUA_SRC" "${DIR}/bin/tentacle-opcua${EXT}"
              chmod +x "${DIR}/bin/tentacle-opcua${EXT}" 2>/dev/null || true
            fi

            # Deno service sources + nats-schema (platform-independent)
            for svc in graphql ethernetip mqtt modbus nftables; do
              [ -d "services/tentacle-${svc}" ] && cp -r "services/tentacle-${svc}" "${DIR}/services/"
            done
            # network and nftables are Linux-only
            if [ "$OS" = "linux" ]; then
              for svc in network nftables; do
                [ -d "services/tentacle-${svc}" ] && cp -r "services/tentacle-${svc}" "${DIR}/services/"
              done
            fi
            [ -d "services/tentacle-web" ]         && cp -r "services/tentacle-web"         "${DIR}/services/"
            [ -d "services/tentacle-nats-schema" ] && cp -r "services/tentacle-nats-schema" "${DIR}/services/"

            # Pre-cached Deno dependency cache
            [ -d "deno-cache" ] && cp -r deno-cache "${DIR}/services/deno-cache"

            # Deploy files from this repo
            cp deploy/install.sh "${DIR}/deploy/"
            chmod +x "${DIR}/deploy/install.sh"
            sed -i "s/{{VERSION}}/${VERSION}/g" "${DIR}/deploy/install.sh"
            cp deploy/docker-compose.yml "${DIR}/deploy/" 2>/dev/null || true
            cp deploy/Dockerfile.* "${DIR}/deploy/" 2>/dev/null || true
            cp config/tentacle.env.example "${DIR}/config/"

            if [ "$OS" = "linux" ]; then
              cp deploy/systemd/*.service "${DIR}/deploy/systemd/"
            fi

            if [ "$OS" = "windows" ] || [ "$OS" = "darwin" ]; then
              cp deploy/install.ps1 "${DIR}/deploy/"
              sed -i "s/{{VERSION}}/${VERSION}/g" "${DIR}/deploy/install.ps1"
            fi

            # Create archive
            if [ "$OS" = "windows" ]; then
              zip -r "dist/tentacle-v${VERSION}-${PLATFORM}.zip" "${DIR}"
            else
              tar czf "dist/tentacle-v${VERSION}-${PLATFORM}.tar.gz" "${DIR}"
            fi
          done

      - name: Build Makeself .run archives
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sudo apt-get install -y -qq makeself

          for ARCH in amd64 arm64; do
            PLATFORM="linux-${ARCH}"
            SRC_DIR="tentacle-v${VERSION}-${PLATFORM}"
            if [ -d "$SRC_DIR" ]; then
              makeself --gzip --sha256 \
                "$SRC_DIR" \
                "dist/tentacle-v${VERSION}-${PLATFORM}.run" \
                "Tentacle v${VERSION} Installer (Linux ${ARCH})" \
                ./deploy/install.sh --bundled
            fi
          done

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > SHA256SUMS

      - uses: actions/upload-artifact@v4
        with:
          name: release-archives
          path: dist/

  # ═══════════════════════════════════════════════════════════════════════════
  # Create GitHub Release
  # ═══════════════════════════════════════════════════════════════════════════
  release:
    needs: [package]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download release archives
        uses: actions/download-artifact@v4
        with:
          name: release-archives
          path: dist/

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Tentacle v${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            dist/tentacle-v*.tar.gz
            dist/tentacle-v*.zip
            dist/tentacle-v*.run
            dist/SHA256SUMS
